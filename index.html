<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & TOKENS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

        :root {
            --sidebar-bg:#171717; --sidebar-hover:#2a2a2a; --sidebar-active:#343434;
            --sidebar-text:#ececec; --sidebar-muted:#8e8e8e; --sidebar-border:#2e2e2e;
            --chat-bg:#212121; --msg-bg:#2f2f2f; --user-bubble:#303030;
            --text-primary:#ececec; --text-secondary:#b4b4b4;
            --accent:#10a37f; --accent-hover:#0d8c6d;
            --input-bg:#2f2f2f; --input-border:#424242; --border-color:#2e2e2e;
            --danger:#ef4444; --code-bg:#0d0d0d;
            --profile-blue:#3b82f6; --profile-blue-hover:#2563eb;
            --intent-general:#8e8e8e; --intent-continuation:#f59e0b;
            --intent-kb:#10a37f; --intent-profile:#3b82f6;
            --intent-privacy:#ef4444; --intent-profile-update:#8b5cf6;
        }

        body {
            font-family:'SÃ¶hne',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica Neue',sans-serif;
            background:var(--chat-bg); color:var(--text-primary);
            height:100vh; overflow:hidden;
        }

        .app { display:flex; height:100vh; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .sidebar {
            width:260px; background:var(--sidebar-bg); display:flex;
            flex-direction:column; flex-shrink:0;
            border-right:1px solid var(--sidebar-border); transition:width .2s;
        }
        .sidebar.collapsed { width:0; overflow:hidden; border-right:none; }

        .sidebar-header { padding:12px; display:flex; gap:8px; }

        .new-chat-btn {
            flex:1; display:flex; align-items:center; gap:8px;
            padding:10px 14px; background:transparent;
            border:1px solid var(--sidebar-border); border-radius:8px;
            color:var(--sidebar-text); font-size:14px; cursor:pointer;
            transition:background .15s;
        }
        .new-chat-btn:hover { background:var(--sidebar-hover); }
        .new-chat-btn svg { width:18px; height:18px; flex-shrink:0; }

        .toggle-sidebar-btn {
            display:flex; align-items:center; justify-content:center;
            width:40px; background:transparent;
            border:1px solid var(--sidebar-border); border-radius:8px;
            color:var(--sidebar-text); cursor:pointer; transition:background .15s;
        }
        .toggle-sidebar-btn:hover { background:var(--sidebar-hover); }

        .conversation-list { flex:1; overflow-y:auto; padding:4px 8px; }
        .conversation-list::-webkit-scrollbar { width:4px; }
        .conversation-list::-webkit-scrollbar-thumb { background:var(--sidebar-border); border-radius:4px; }

        .conv-group-label {
            padding:10px 12px 4px; font-size:11px; font-weight:600;
            color:var(--sidebar-muted); text-transform:uppercase; letter-spacing:.5px;
        }

        .conv-item {
            display:flex; align-items:center; padding:10px 12px;
            border-radius:8px; cursor:pointer; font-size:14px;
            color:var(--sidebar-text); transition:background .15s;
            position:relative; gap:8px;
        }
        .conv-item:hover { background:var(--sidebar-hover); }
        .conv-item.active { background:var(--sidebar-active); }

        .conv-item-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

        .conv-item-actions { display:none; gap:2px; flex-shrink:0; }
        .conv-item:hover .conv-item-actions { display:flex; }

        .conv-action-btn {
            background:transparent; border:none; color:var(--sidebar-muted);
            cursor:pointer; padding:4px; border-radius:4px;
            display:flex; align-items:center; justify-content:center;
            transition:color .15s, background .15s;
        }
        .conv-action-btn:hover { color:var(--sidebar-text); background:rgba(255,255,255,.1); }
        .conv-action-btn.delete:hover { color:var(--danger); }
        .conv-action-btn svg { width:16px; height:16px; }

        .rename-input {
            flex:1; background:var(--input-bg); border:1px solid var(--accent);
            border-radius:4px; padding:4px 8px; color:var(--text-primary);
            font-size:14px; font-family:inherit; outline:none;
        }

        .sidebar-footer {
            padding:12px; border-top:1px solid var(--sidebar-border);
            display:flex; flex-direction:column; gap:8px;
        }

        .profile-btn {
            display:flex; align-items:center; gap:8px; padding:10px 14px;
            background:transparent; border:1px solid var(--sidebar-border);
            border-radius:8px; color:var(--sidebar-text); font-size:13px;
            cursor:pointer; transition:background .15s, border-color .15s;
        }
        .profile-btn:hover { background:var(--sidebar-hover); border-color:var(--profile-blue); }
        .profile-btn svg { width:16px; height:16px; flex-shrink:0; color:var(--profile-blue); }
        .profile-btn .profile-count {
            margin-left:auto; background:var(--profile-blue); color:#fff;
            font-size:11px; font-weight:700; padding:2px 7px;
            border-radius:10px; min-width:20px; text-align:center;
        }

        .sidebar-footer-text { font-size:12px; color:var(--sidebar-muted); text-align:center; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CHAT AREA
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main { flex:1; display:flex; flex-direction:column; min-width:0; position:relative; }

        .chat-topbar {
            display:flex; align-items:center; padding:12px 16px;
            border-bottom:1px solid var(--border-color);
            background:var(--chat-bg); min-height:52px;
        }

        .topbar-toggle {
            display:none; background:transparent; border:none;
            color:var(--text-primary); cursor:pointer; padding:6px;
            border-radius:6px; margin-right:8px;
        }
        .sidebar.collapsed ~ .main .topbar-toggle { display:flex; }
        .topbar-toggle:hover { background:var(--sidebar-hover); }

        .topbar-title {
            font-size:16px; font-weight:600; color:var(--text-primary);
            overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
        }

        /* â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .messages-wrapper { flex:1; overflow-y:auto; scroll-behavior:smooth; position:relative; }
        .messages-wrapper::-webkit-scrollbar { width:6px; }
        .messages-wrapper::-webkit-scrollbar-thumb { background:var(--sidebar-border); border-radius:6px; }

        .messages-container { max-width:768px; margin:0 auto; padding:16px 24px 100px; }

        /* Welcome */
        .welcome-screen {
            display:flex; flex-direction:column; align-items:center;
            justify-content:center; height:100%; text-align:center; padding:40px 20px;
        }
        .welcome-logo {
            width:56px; height:56px; background:var(--accent); border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            margin-bottom:20px; font-size:24px;
        }
        .welcome-screen h1 { font-size:28px; font-weight:700; margin-bottom:12px; }
        .welcome-screen p { color:var(--text-secondary); font-size:16px; max-width:500px; line-height:1.6; margin-bottom:32px; }

        .suggestions { display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:600px; width:100%; }
        .suggestion-card {
            background:var(--msg-bg); border:1px solid var(--border-color);
            border-radius:12px; padding:16px; text-align:left; cursor:pointer;
            transition:background .15s, border-color .15s;
            font-size:14px; line-height:1.5; color:var(--text-secondary);
        }
        .suggestion-card:hover { background:var(--sidebar-hover); border-color:var(--sidebar-muted); }
        .suggestion-card strong { display:block; color:var(--text-primary); margin-bottom:4px; }

        /* â”€â”€ Message bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .message-row { padding:18px 0; animation:fadeIn .25s ease; position:relative; }
        .message-row:hover .msg-actions { opacity:1; }

        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        .message-row .avatar-name { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
        .avatar {
            width:28px; height:28px; border-radius:4px; display:flex;
            align-items:center; justify-content:center;
            font-size:13px; font-weight:700; flex-shrink:0;
        }
        .avatar.user { background:#5436da; color:#fff; }
        .avatar.assistant { background:var(--accent); color:#fff; }
        .sender-name { font-weight:600; font-size:14px; }

        .message-body { padding-left:38px; font-size:15px; line-height:1.7; color:var(--text-primary); }
        .message-body p { margin-bottom:10px; }
        .message-body p:last-child { margin-bottom:0; }
        .message-body ul,.message-body ol { margin:8px 0 8px 20px; }
        .message-body li { margin-bottom:4px; }
        .message-body strong { font-weight:600; }
        .message-body em { font-style:italic; color:var(--text-secondary); }
        .message-body a { color:var(--accent); text-decoration:underline; }

        /* Code blocks */
        .message-body pre { background:var(--code-bg); border-radius:8px; margin:12px 0; overflow:hidden; }
        .code-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:8px 16px; background:#1a1a1a; font-size:12px; color:var(--sidebar-muted);
        }
        .copy-code-btn {
            background:transparent; border:none; color:var(--sidebar-muted);
            cursor:pointer; font-size:12px; padding:2px 8px; border-radius:4px;
            transition:color .15s, background .15s; display:flex; align-items:center; gap:4px;
        }
        .copy-code-btn:hover { color:var(--text-primary); background:rgba(255,255,255,.1); }
        .message-body pre code {
            display:block; padding:16px;
            font-family:'SÃ¶hne Mono','Fira Code','Consolas',monospace;
            font-size:13px; line-height:1.6; overflow-x:auto;
        }
        .message-body code {
            background:rgba(255,255,255,.1); padding:2px 6px; border-radius:4px;
            font-family:'SÃ¶hne Mono','Fira Code','Consolas',monospace; font-size:13px;
        }
        .message-body pre code { background:transparent; padding:0; }
        .message-body blockquote { border-left:3px solid var(--accent); padding-left:16px; margin:12px 0; color:var(--text-secondary); }
        .message-body table { border-collapse:collapse; margin:12px 0; width:100%; }
        .message-body th,.message-body td { border:1px solid var(--border-color); padding:8px 12px; text-align:left; }
        .message-body th { background:var(--sidebar-hover); font-weight:600; }

        pre code::-webkit-scrollbar { height:6px; }
        pre code::-webkit-scrollbar-thumb { background:var(--sidebar-border); border-radius:4px; }

        /* â”€â”€ Message action buttons (copy / regenerate) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg-actions {
            display:flex; gap:2px; padding-left:38px; margin-top:4px;
            opacity:0; transition:opacity .15s;
        }
        .msg-action-btn {
            background:transparent; border:none; color:var(--sidebar-muted);
            cursor:pointer; padding:5px 8px; border-radius:6px;
            font-size:12px; display:flex; align-items:center; gap:4px;
            transition:color .15s, background .15s;
        }
        .msg-action-btn:hover { color:var(--text-primary); background:rgba(255,255,255,.08); }
        .msg-action-btn svg { width:14px; height:14px; }

        /* â”€â”€ Intent badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .message-meta { padding-left:38px; margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; }
        .meta-badge {
            display:inline-flex; align-items:center; gap:4px;
            font-size:11px; color:var(--sidebar-muted);
            background:rgba(255,255,255,.05); border-radius:12px; padding:3px 10px;
        }
        .meta-badge.intent-general { color:var(--intent-general); }
        .meta-badge.intent-continuation { color:var(--intent-continuation); }
        .meta-badge.intent-kb { color:var(--intent-kb); }
        .meta-badge.intent-profile { color:var(--intent-profile); }
        .meta-badge.intent-privacy { color:var(--intent-privacy); }
        .meta-badge.intent-profile-update { color:var(--intent-profile-update); }
        .meta-badge.docs { color:var(--accent); }

        /* â”€â”€ Typing dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .typing-dots { display:inline-flex; gap:4px; padding:4px 0; }
        .typing-dots span { width:8px; height:8px; background:var(--text-secondary); border-radius:50%; animation:bounce 1.4s infinite; }
        .typing-dots span:nth-child(2) { animation-delay:.2s; }
        .typing-dots span:nth-child(3) { animation-delay:.4s; }

        @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }

        /* Streaming cursor */
        .streaming-body::after {
            content:'â–‹'; display:inline-block;
            animation:blink-cursor .7s step-end infinite;
            opacity:.7; margin-left:1px;
        }
        @keyframes blink-cursor { 0%,100%{opacity:.7} 50%{opacity:0} }

        /* â”€â”€ Scroll-to-bottom FAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .scroll-fab {
            position:absolute; bottom:110px; left:50%; transform:translateX(-50%);
            width:36px; height:36px; border-radius:50%;
            background:var(--msg-bg); border:1px solid var(--border-color);
            color:var(--text-secondary); cursor:pointer;
            display:none; align-items:center; justify-content:center;
            box-shadow:0 2px 8px rgba(0,0,0,.3); z-index:10;
            transition:background .15s, color .15s;
        }
        .scroll-fab:hover { background:var(--sidebar-hover); color:var(--text-primary); }
        .scroll-fab.visible { display:flex; }
        .scroll-fab svg { width:18px; height:18px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INPUT AREA
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .input-area {
            position:absolute; bottom:0; left:0; right:0;
            padding:16px 24px 24px;
            background:linear-gradient(transparent, var(--chat-bg) 30%);
        }
        .input-container { max-width:768px; margin:0 auto; position:relative; }

        .input-box {
            display:flex; align-items:flex-end; gap:0;
            background:var(--input-bg); border:1px solid var(--input-border);
            border-radius:16px; padding:4px 4px 4px 16px;
            transition:border-color .2s;
        }
        .input-box:focus-within { border-color:var(--sidebar-muted); }

        .input-box textarea {
            flex:1; background:transparent; border:none;
            color:var(--text-primary); font-size:15px; font-family:inherit;
            line-height:1.5; resize:none; outline:none;
            padding:10px 0; max-height:200px; min-height:24px;
        }
        .input-box textarea::placeholder { color:var(--sidebar-muted); }

        .send-btn, .stop-btn {
            width:36px; height:36px; border:none; border-radius:10px;
            color:#fff; cursor:pointer; display:flex;
            align-items:center; justify-content:center;
            flex-shrink:0; margin-bottom:2px; transition:background .15s, opacity .15s;
        }
        .send-btn { background:var(--accent); }
        .send-btn:hover:not(:disabled) { background:var(--accent-hover); }
        .send-btn:disabled { opacity:.4; cursor:not-allowed; }
        .send-btn svg { width:18px; height:18px; }

        .stop-btn { background:var(--danger); display:none; }
        .stop-btn:hover { background:#dc2626; }
        .stop-btn svg { width:16px; height:16px; }

        .input-footer { text-align:center; padding-top:8px; font-size:12px; color:var(--sidebar-muted); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PROFILE MODAL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-overlay {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.6); z-index:200;
            justify-content:center; align-items:center;
        }
        .modal-overlay.active { display:flex; }
        .modal {
            background:var(--sidebar-bg); border:1px solid var(--sidebar-border);
            border-radius:16px; width:560px; max-width:95vw; max-height:80vh;
            display:flex; flex-direction:column;
            box-shadow:0 20px 60px rgba(0,0,0,.5); animation:slideUp .2s ease;
        }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

        .modal-header {
            display:flex; align-items:center; justify-content:space-between;
            padding:20px 24px 16px; border-bottom:1px solid var(--sidebar-border);
        }
        .modal-header h2 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:10px; }
        .modal-header h2 svg { color:var(--profile-blue); }

        .modal-close-btn {
            background:transparent; border:none; color:var(--sidebar-muted);
            cursor:pointer; padding:6px; border-radius:6px; display:flex;
            transition:color .15s, background .15s;
        }
        .modal-close-btn:hover { color:var(--text-primary); background:rgba(255,255,255,.1); }

        .modal-description {
            padding:16px 24px; font-size:13px; color:var(--text-secondary);
            line-height:1.5; border-bottom:1px solid var(--sidebar-border);
        }

        .modal-body { flex:1; overflow-y:auto; padding:16px 24px; }
        .modal-body::-webkit-scrollbar { width:4px; }
        .modal-body::-webkit-scrollbar-thumb { background:var(--sidebar-border); border-radius:4px; }

        .add-profile-row { display:flex; gap:8px; margin-bottom:16px; }
        .add-profile-key, .add-profile-value {
            background:var(--input-bg); border:1px solid var(--input-border);
            border-radius:10px; padding:10px 14px; color:var(--text-primary);
            font-size:14px; font-family:inherit; outline:none; transition:border-color .2s;
        }
        .add-profile-key { width:140px; }
        .add-profile-value { flex:1; }
        .add-profile-key:focus, .add-profile-value:focus { border-color:var(--profile-blue); }
        .add-profile-key::placeholder, .add-profile-value::placeholder { color:var(--sidebar-muted); }

        .add-profile-btn {
            padding:10px 18px; background:var(--profile-blue); color:#fff;
            border:none; border-radius:10px; font-size:14px; font-weight:600;
            cursor:pointer; transition:background .15s; white-space:nowrap;
        }
        .add-profile-btn:hover { background:var(--profile-blue-hover); }
        .add-profile-btn:disabled { opacity:.5; cursor:not-allowed; }

        .profile-list { display:flex; flex-direction:column; gap:8px; }
        .profile-item {
            display:flex; align-items:flex-start; gap:12px;
            padding:12px 14px; background:var(--msg-bg);
            border:1px solid var(--border-color); border-radius:10px;
            transition:border-color .15s;
        }
        .profile-item:hover { border-color:var(--sidebar-muted); }
        .profile-icon { color:var(--profile-blue); flex-shrink:0; margin-top:2px; }
        .profile-content { flex:1; min-width:0; }
        .profile-key-label {
            font-size:11px; font-weight:600; text-transform:uppercase;
            letter-spacing:.5px; color:var(--profile-blue); margin-bottom:2px;
        }
        .profile-value-text { font-size:14px; line-height:1.5; color:var(--text-primary); word-break:break-word; }
        .profile-info { display:flex; align-items:center; gap:8px; margin-top:6px; }
        .profile-category {
            font-size:11px; font-weight:600; text-transform:uppercase;
            letter-spacing:.5px; color:var(--accent);
            background:rgba(16,163,127,.15); padding:2px 8px; border-radius:6px;
        }
        .profile-date { font-size:11px; color:var(--sidebar-muted); }
        .profile-actions { display:flex; gap:2px; flex-shrink:0; }
        .profile-action-btn {
            background:transparent; border:none; color:var(--sidebar-muted);
            cursor:pointer; padding:6px; border-radius:6px;
            display:flex; align-items:center; transition:color .15s, background .15s;
        }
        .profile-action-btn:hover { color:var(--text-primary); background:rgba(255,255,255,.1); }
        .profile-action-btn.delete:hover { color:var(--danger); }
        .profile-action-btn svg { width:14px; height:14px; }

        .profile-edit-input {
            width:100%; background:var(--input-bg); border:1px solid var(--profile-blue);
            border-radius:6px; padding:6px 10px; color:var(--text-primary);
            font-size:14px; font-family:inherit; outline:none; line-height:1.5;
        }
        .profile-empty { text-align:center; padding:40px 20px; color:var(--sidebar-muted); }
        .profile-empty svg { width:48px; height:48px; margin-bottom:12px; color:var(--sidebar-border); }
        .profile-empty p { font-size:14px; margin-bottom:4px; }
        .profile-empty small { font-size:12px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width:768px) {
            .sidebar { position:fixed; left:0; top:0; bottom:0; z-index:100; width:280px; }
            .sidebar.collapsed { width:0; }
            .topbar-toggle { display:flex !important; }
            .suggestions { grid-template-columns:1fr; }
            .messages-container { padding:16px 16px 100px; }
            .input-area { padding:12px 16px 16px; }
        }
        .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:99; }
        @media (max-width:768px) { .sidebar:not(.collapsed)~.sidebar-overlay { display:block; } }
    </style>
</head>
<body>
<div class="app">
    <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="newChatBtn" title="New Chat (Ctrl+Shift+O)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                New chat
            </button>
            <button class="toggle-sidebar-btn" id="closeSidebarBtn" title="Close sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/></svg>
            </button>
        </div>
        <div class="conversation-list" id="conversationList"></div>
        <div class="sidebar-footer">
            <button class="profile-btn" id="profileBtn" title="User profile">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Profile
                <span class="profile-count" id="profileCount" style="display:none">0</span>
            </button>
            <div class="sidebar-footer-text">RAG Chat &middot; Intent-gated architecture</div>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <main class="main">
        <div class="chat-topbar">
            <button class="topbar-toggle" id="openSidebarBtn" title="Open sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <span class="topbar-title" id="topbarTitle">New Chat</span>
        </div>

        <div class="messages-wrapper" id="messagesWrapper">
            <div class="messages-container" id="messagesContainer"></div>
            <button class="scroll-fab" id="scrollFab" title="Scroll to bottom">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
            </button>
        </div>

        <div class="input-area">
            <div class="input-container">
                <div class="input-box">
                    <textarea id="userInput" rows="1" placeholder="Message RAG Chatâ€¦" autofocus></textarea>
                    <button class="send-btn" id="sendBtn" disabled title="Send message">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                    <button class="stop-btn" id="stopBtn" title="Stop generating">
                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    </button>
                </div>
                <div class="input-footer">Powered by Cerebras LLM &middot; Intent-gated retrieval</div>
            </div>
        </div>
    </main>
</div>

<!-- â”€â”€ Profile Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="profileModal">
    <div class="modal">
        <div class="modal-header">
            <h2>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                User Profile
            </h2>
            <button class="modal-close-btn" id="closeProfileModal" title="Close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-description">
            Your profile stores stable identity data â€” name, preferences, tools you use. This info is only injected when the AI detects your question depends on it. You can also add entries manually.
        </div>
        <div class="modal-body">
            <div class="add-profile-row">
                <input type="text" class="add-profile-key" id="addProfileKey" placeholder="Key (e.g. name)">
                <input type="text" class="add-profile-value" id="addProfileValue" placeholder="Value (e.g. Keshav)">
                <button class="add-profile-btn" id="addProfileBtn">Add</button>
            </div>
            <div class="profile-list" id="profileList"></div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let conversations = [];
let activeConversationId = null;
let isGenerating = false;
let profileEntries = [];
let abortController = null;       // for stop-generation
let lastAssistantQuery = null;     // for regenerate

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = s => document.getElementById(s);
const sidebar          = $('sidebar');
const sidebarOverlay   = $('sidebarOverlay');
const conversationList = $('conversationList');
const messagesContainer= $('messagesContainer');
const messagesWrapper  = $('messagesWrapper');
const userInput        = $('userInput');
const sendBtn          = $('sendBtn');
const stopBtn          = $('stopBtn');
const topbarTitle      = $('topbarTitle');
const newChatBtn       = $('newChatBtn');
const closeSidebarBtn  = $('closeSidebarBtn');
const openSidebarBtn   = $('openSidebarBtn');
const profileBtn       = $('profileBtn');
const profileModal     = $('profileModal');
const closeProfileModal= $('closeProfileModal');
const profileList      = $('profileList');
const profileCountBadge= $('profileCount');
const addProfileKey    = $('addProfileKey');
const addProfileValue  = $('addProfileValue');
const addProfileBtn    = $('addProfileBtn');
const scrollFab        = $('scrollFab');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKED CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
marked.setOptions({ breaks:true, gfm:true });
const renderer = new marked.Renderer();
renderer.code = function(code, language) {
    let codeText, lang;
    if (typeof code === 'object' && code !== null) { codeText = code.text||''; lang = code.lang||language||''; }
    else { codeText = code||''; lang = language||''; }
    const highlighted = lang && hljs.getLanguage(lang)
        ? hljs.highlight(codeText,{language:lang}).value
        : hljs.highlightAuto(codeText).value;
    const displayLang = lang || 'code';
    return `<pre><div class="code-header"><span>${displayLang}</span><button class="copy-code-btn" onclick="copyCode(this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy</button></div><code class="hljs">${highlighted}</code></pre>`;
};
marked.setOptions({ renderer });

function renderMarkdown(text) { return marked.parse(text); }

function copyCode(btn) {
    const code = btn.closest('pre').querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
        setTimeout(() => btn.innerHTML = orig, 2000);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escapeHtml(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function scrollToBottom() { messagesWrapper.scrollTop = messagesWrapper.scrollHeight; }

// Scroll-to-bottom FAB visibility
messagesWrapper.addEventListener('scroll', () => {
    const gap = messagesWrapper.scrollHeight - messagesWrapper.scrollTop - messagesWrapper.clientHeight;
    scrollFab.classList.toggle('visible', gap > 200);
});
scrollFab.addEventListener('click', scrollToBottom);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(show) {
    if (show === undefined) show = sidebar.classList.contains('collapsed');
    sidebar.classList.toggle('collapsed', !show);
    localStorage.setItem('sidebarOpen', show);
}
closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
openSidebarBtn.addEventListener('click', () => toggleSidebar(true));
sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
if (localStorage.getItem('sidebarOpen') === 'false') sidebar.classList.add('collapsed');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONVERSATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConversations() {
    try {
        const r = await fetch('/conversations'); const d = await r.json();
        conversations = d.conversations || []; renderConversationList();
    } catch(e) { console.error('Load conversations:', e); }
}

function groupConversations(convs) {
    const now=new Date(), today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const yesterday=new Date(today); yesterday.setDate(today.getDate()-1);
    const weekAgo=new Date(today); weekAgo.setDate(today.getDate()-7);
    const monthAgo=new Date(today); monthAgo.setDate(today.getDate()-30);
    const g = {'Today':[],'Yesterday':[],'Previous 7 Days':[],'Previous 30 Days':[],'Older':[]};
    for (const c of convs) {
        const d=new Date(c.updated_at||c.created_at);
        if (d>=today) g['Today'].push(c);
        else if (d>=yesterday) g['Yesterday'].push(c);
        else if (d>=weekAgo) g['Previous 7 Days'].push(c);
        else if (d>=monthAgo) g['Previous 30 Days'].push(c);
        else g['Older'].push(c);
    }
    return g;
}

function renderConversationList() {
    const groups = groupConversations(conversations);
    let html = '';
    for (const [label, convs] of Object.entries(groups)) {
        if (!convs.length) continue;
        html += `<div class="conv-group-label">${label}</div>`;
        for (const c of convs) {
            html += `
                <div class="conv-item ${c.id===activeConversationId?'active':''}" data-id="${c.id}" onclick="selectConversation('${c.id}')">
                    <span class="conv-item-title">${escapeHtml(c.title)}</span>
                    <div class="conv-item-actions">
                        <button class="conv-action-btn" onclick="event.stopPropagation();startRename('${c.id}')" title="Rename">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5z"/></svg>
                        </button>
                        <button class="conv-action-btn delete" onclick="event.stopPropagation();deleteConv('${c.id}')" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </button>
                    </div>
                </div>`;
        }
    }
    if (!conversations.length) html = '<div style="padding:20px;text-align:center;color:var(--sidebar-muted);font-size:13px;">No conversations yet.<br>Click "New chat" to start!</div>';
    conversationList.innerHTML = html;
}

async function createNewChat() {
    try {
        const r=await fetch('/conversations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:'New Chat'})});
        const conv=await r.json();
        activeConversationId=conv.id;
        conversations.unshift({...conv,message_count:0,updated_at:conv.created_at});
        renderConversationList(); showWelcome();
        topbarTitle.textContent='New Chat'; userInput.focus();
        if(window.innerWidth<=768) toggleSidebar(false);
    } catch(e){ console.error('Create chat:',e); }
}

async function selectConversation(id) {
    if(id===activeConversationId) return;
    activeConversationId=id; renderConversationList();
    const conv=conversations.find(c=>c.id===id);
    topbarTitle.textContent=conv?conv.title:'Chat';
    try {
        const r=await fetch(`/conversations/${id}/messages`); const d=await r.json();
        renderMessages(d.messages||[]);
    } catch(e){ console.error('Load messages:',e); }
    if(window.innerWidth<=768) toggleSidebar(false);
    userInput.focus();
}

async function deleteConv(id) {
    if(!confirm('Delete this conversation?')) return;
    try {
        await fetch(`/conversations/${id}`,{method:'DELETE'});
        conversations=conversations.filter(c=>c.id!==id);
        if(activeConversationId===id){ activeConversationId=null; showWelcome(); topbarTitle.textContent='New Chat'; }
        renderConversationList();
    } catch(e){ console.error('Delete:',e); }
}

function startRename(id) {
    const item=document.querySelector(`.conv-item[data-id="${id}"]`);
    if(!item) return;
    const titleEl=item.querySelector('.conv-item-title');
    const cur=titleEl.textContent;
    const input=document.createElement('input'); input.className='rename-input'; input.value=cur;
    titleEl.replaceWith(input); input.focus(); input.select();
    const finish=async()=>{
        const t=input.value.trim()||cur;
        if(t!==cur){ try{ await fetch(`/conversations/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:t})}); const c=conversations.find(x=>x.id===id); if(c)c.title=t; if(activeConversationId===id)topbarTitle.textContent=t; }catch(e){console.error('Rename:',e);} }
        renderConversationList();
    };
    input.addEventListener('blur',finish);
    input.addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();input.blur();} if(e.key==='Escape'){input.value=cur;input.blur();} });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const intentLabels = {
    general:        {label:'General knowledge', icon:'ğŸ§ ', css:'intent-general'},
    continuation:   {label:'Conversation context', icon:'ğŸ’¬', css:'intent-continuation'},
    knowledge_base: {label:'Knowledge base', icon:'ğŸ“š', css:'intent-kb'},
    profile:        {label:'Profile-aware', icon:'ğŸ‘¤', css:'intent-profile'},
    profile_update: {label:'Saving to profile', icon:'ğŸ’¾', css:'intent-profile-update'},
    privacy:        {label:'Privacy response', icon:'ğŸ”’', css:'intent-privacy'},
};

function showWelcome() {
    messagesContainer.innerHTML = `
        <div class="welcome-screen">
            <div class="welcome-logo">R</div>
            <h1>RAG Chat</h1>
            <p>AI assistant with intent-gated retrieval. I think first, then retrieve only when needed â€” general knowledge, KB search, conversation context, or your profile.</p>
            <div class="suggestions">
                <div class="suggestion-card" onclick="useSuggestion('Describe Montserrat')"><strong>General Knowledge</strong>Describe Montserrat (tests: no retrieval needed)</div>
                <div class="suggestion-card" onclick="useSuggestion('How does FAISS perform similarity search?')"><strong>Knowledge Base</strong>How does FAISS perform similarity search?</div>
                <div class="suggestion-card" onclick="useSuggestion('My name is Keshav and I prefer Python')"><strong>Profile Update</strong>Tell the AI your name and preferences</div>
                <div class="suggestion-card" onclick="useSuggestion('Explain the difference between L2 and cosine distance')"><strong>Deep Dive</strong>Compare L2 and cosine distance metrics</div>
            </div>
        </div>`;
}

function useSuggestion(text) { userInput.value=text; autoResize(); sendBtn.disabled=false; userInput.focus(); }

function renderMessages(messages) {
    if(!messages.length){ showWelcome(); return; }
    messagesContainer.innerHTML='';
    for(const m of messages) appendMessage(m.role, m.content, false);
    scrollToBottom();
}

function buildBadges(meta) {
    if(!meta) return '';
    const badges=[];
    const ri=meta.retrieval_info||{};
    if(meta.intent){
        const key=ri.route==='profile_update'?'profile_update':ri.route==='privacy'?'privacy':meta.intent;
        const info=intentLabels[key]||intentLabels.general;
        badges.push(`<span class="meta-badge ${info.css}">${info.icon} ${info.label}</span>`);
    }
    if(ri.num_docs>0) badges.push(`<span class="meta-badge docs"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg> ${ri.num_docs} docs</span>`);
    if(ri.similar_queries>0) badges.push(`<span class="meta-badge intent-continuation"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg> ${ri.similar_queries} related Q&A</span>`);
    if(ri.same_conv_qa>0) badges.push(`<span class="meta-badge intent-continuation">${ri.same_conv_qa} context refs</span>`);
    return badges.length ? `<div class="message-meta">${badges.join('')}</div>` : '';
}

function appendMessage(role, content, animate=true, meta=null) {
    const isUser = role==='user';
    const row = document.createElement('div');
    row.className = 'message-row';
    if(!animate) row.style.animation='none';

    const avatarCls = isUser?'user':'assistant';
    const avatarLbl = isUser?'Y':'R';
    const name = isUser?'You':'RAG Chat';

    let actionsHtml = '';
    if(!isUser) {
        actionsHtml = `
            <div class="msg-actions">
                <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy
                </button>
                <button class="msg-action-btn" onclick="regenerateMessage(this)" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
                    Regenerate
                </button>
            </div>`;
    }

    row.innerHTML = `
        <div class="avatar-name">
            <div class="avatar ${avatarCls}">${avatarLbl}</div>
            <span class="sender-name">${name}</span>
        </div>
        <div class="message-body">${isUser ? escapeHtml(content) : renderMarkdown(content)}</div>
        ${isUser ? '' : buildBadges(meta)}
        ${actionsHtml}`;

    // Store raw text for copy
    if(!isUser) row.dataset.rawText = content;

    messagesContainer.appendChild(row);
}

function appendTypingIndicator() {
    const row=document.createElement('div'); row.className='message-row'; row.id='typingRow';
    row.innerHTML=`<div class="avatar-name"><div class="avatar assistant">R</div><span class="sender-name">RAG Chat</span></div><div class="message-body"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
    messagesContainer.appendChild(row); scrollToBottom();
}
function removeTypingIndicator() { const el=document.getElementById('typingRow'); if(el) el.remove(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY & REGENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyMessage(btn) {
    const row = btn.closest('.message-row');
    const raw = row.dataset.rawText || row.querySelector('.message-body').textContent;
    navigator.clipboard.writeText(raw).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
        setTimeout(() => btn.innerHTML = orig, 2000);
    });
}

function regenerateMessage(btn) {
    if(isGenerating) return;
    const row = btn.closest('.message-row');
    // Find the user message right before this assistant message
    const allRows = [...messagesContainer.querySelectorAll('.message-row')];
    const idx = allRows.indexOf(row);
    let userQuery = null;
    for(let i=idx-1; i>=0; i--) {
        const body = allRows[i].querySelector('.message-body');
        const avatar = allRows[i].querySelector('.avatar');
        if(avatar && avatar.classList.contains('user')) {
            userQuery = body.textContent; break;
        }
    }
    if(!userQuery) return;
    // Remove this assistant message
    row.remove();
    // Re-send the query
    streamMessage(userQuery);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND / STREAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setGenerating(val) {
    isGenerating = val;
    sendBtn.style.display = val ? 'none' : 'flex';
    stopBtn.style.display = val ? 'flex' : 'none';
    updateSendBtn();
}

async function sendMessage() {
    const message = userInput.value.trim();
    if(!message || isGenerating) return;

    // Auto-create conversation if needed
    if(!activeConversationId) {
        try {
            const r=await fetch('/conversations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:'New Chat'})});
            const conv=await r.json(); activeConversationId=conv.id;
            conversations.unshift({...conv,message_count:0,updated_at:conv.created_at});
            renderConversationList();
        } catch(e){ console.error('Create conversation:',e); return; }
    }

    const welcomeEl = messagesContainer.querySelector('.welcome-screen');
    if(welcomeEl) messagesContainer.innerHTML='';

    appendMessage('user', message); scrollToBottom();
    userInput.value=''; autoResize();

    streamMessage(message);
}

async function streamMessage(message) {
    lastAssistantQuery = message;
    setGenerating(true);
    appendTypingIndicator();

    abortController = new AbortController();

    try {
        const res = await fetch('/chat/stream', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ user_query:message, conversation_id:activeConversationId }),
            signal:abortController.signal,
        });

        if(!res.ok) throw new Error(`Server error: ${res.status}`);

        removeTypingIndicator();

        // Create streaming assistant bubble
        const row = document.createElement('div');
        row.className = 'message-row';
        row.innerHTML = `
            <div class="avatar-name"><div class="avatar assistant">R</div><span class="sender-name">RAG Chat</span></div>
            <div class="message-body streaming-body"></div>`;
        messagesContainer.appendChild(row); scrollToBottom();
        const bodyEl = row.querySelector('.message-body');

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer='', fullText='', finalMeta=null;

        while(true) {
            const {done, value} = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, {stream:true});

            const lines = buffer.split('\n');
            buffer = lines.pop();

            for(const line of lines) {
                if(!line.trim()) continue;
                const ci = line.indexOf(':');
                if(ci===-1) continue;
                const code = line.slice(0,ci), payload = line.slice(ci+1);

                if(code==='0') {
                    try { fullText += JSON.parse(payload); bodyEl.innerHTML = renderMarkdown(fullText); scrollToBottom(); } catch(_){}
                } else if(code==='8') {
                    try { const ann=JSON.parse(payload); if(ann&&ann[0]) finalMeta={intent:ann[0].intent||'general',confidence:ann[0].confidence||0,retrieval_info:ann[0].retrieval_info||{}}; } catch(_){}
                }
            }
        }

        // Finalize
        bodyEl.classList.remove('streaming-body');
        row.dataset.rawText = fullText;

        // Append badges
        if(finalMeta) {
            const badgeHtml = buildBadges(finalMeta);
            if(badgeHtml) row.insertAdjacentHTML('beforeend', badgeHtml);
        }

        // Append action buttons
        row.insertAdjacentHTML('beforeend', `
            <div class="msg-actions">
                <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy
                </button>
                <button class="msg-action-btn" onclick="regenerateMessage(this)" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
                    Regenerate
                </button>
            </div>`);

        scrollToBottom();

        // Refresh sidebar title
        setTimeout(async()=>{ await loadConversations(); const c=conversations.find(x=>x.id===activeConversationId); if(c) topbarTitle.textContent=c.title; }, 1500);
        setTimeout(loadProfileCount, 3000);

    } catch(e) {
        removeTypingIndicator();
        if(e.name === 'AbortError') {
            // Stopped by user â€” finalize whatever we have
            const streamingEl = messagesContainer.querySelector('.streaming-body');
            if(streamingEl) streamingEl.classList.remove('streaming-body');
        } else {
            appendMessage('assistant', 'Sorry, something went wrong. Please check that the server is running and try again.');
            console.error('Chat error:', e);
        }
    } finally {
        abortController = null;
        setGenerating(false);
        userInput.focus();
    }
}

// Stop generation
stopBtn.addEventListener('click', () => {
    if(abortController) abortController.abort();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadProfileCount() {
    try {
        const r=await fetch('/profile'); const d=await r.json();
        profileEntries=d.entries||[];
        if(profileEntries.length>0){ profileCountBadge.textContent=profileEntries.length; profileCountBadge.style.display=''; }
        else profileCountBadge.style.display='none';
    } catch(e){ console.error('Profile count:',e); }
}

async function loadProfile() {
    try {
        const r=await fetch('/profile'); const d=await r.json();
        profileEntries=d.entries||[]; renderProfileList();
        if(profileEntries.length>0){ profileCountBadge.textContent=profileEntries.length; profileCountBadge.style.display=''; }
        else profileCountBadge.style.display='none';
    } catch(e){ console.error('Load profile:',e); }
}

function renderProfileList() {
    if(!profileEntries.length){
        profileList.innerHTML=`<div class="profile-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><p>No profile data yet</p><small>Tell the AI about yourself (e.g. "My name isâ€¦") or add entries manually above.</small></div>`;
        return;
    }
    let html='';
    for(const e of profileEntries){
        const ds=new Date(e.updated_at||e.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
        const cat=e.category||'general';
        html+=`
            <div class="profile-item" data-id="${e.id}">
                <div class="profile-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg></div>
                <div class="profile-content">
                    <div class="profile-key-label">${escapeHtml(e.key)}</div>
                    <div class="profile-value-text">${escapeHtml(e.value)}</div>
                    <div class="profile-info"><span class="profile-category">${escapeHtml(cat)}</span><span class="profile-date">${ds}</span></div>
                </div>
                <div class="profile-actions">
                    <button class="profile-action-btn" onclick="editProfile('${e.id}','${escapeHtml(e.key)}')" title="Edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5z"/></svg></button>
                    <button class="profile-action-btn delete" onclick="deleteProfile('${e.id}')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
                </div>
            </div>`;
    }
    profileList.innerHTML=html;
}

async function addProfile() {
    const key=addProfileKey.value.trim(), value=addProfileValue.value.trim();
    if(!key||!value) return;
    addProfileBtn.disabled=true;
    try {
        const r=await fetch('/profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,value,category:'manual'})});
        if(!r.ok) throw new Error();
        addProfileKey.value=''; addProfileValue.value=''; await loadProfile();
    } catch(e){ console.error('Add profile:',e); alert('Failed to add profile entry.'); }
    finally { addProfileBtn.disabled=false; }
}

async function deleteProfile(id) {
    if(!confirm('Remove this profile entry?')) return;
    try { await fetch(`/profile/${id}`,{method:'DELETE'}); await loadProfile(); }
    catch(e){ console.error('Delete profile:',e); }
}

function editProfile(id, key) {
    const item=document.querySelector(`.profile-item[data-id="${id}"]`);
    if(!item) return;
    const textEl=item.querySelector('.profile-value-text');
    const cur=textEl.textContent;
    const input=document.createElement('input'); input.className='profile-edit-input'; input.value=cur;
    textEl.replaceWith(input); input.focus(); input.select();
    const finish=async()=>{
        const t=input.value.trim()||cur;
        if(t!==cur){ try{ await fetch(`/profile/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,value:t,category:'manual'})}); }catch(e){console.error('Update profile:',e);} }
        await loadProfile();
    };
    input.addEventListener('blur',finish);
    input.addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();input.blur();} if(e.key==='Escape'){input.value=cur;input.blur();} });
}

// Profile modal events
profileBtn.addEventListener('click', ()=>{ profileModal.classList.add('active'); loadProfile(); });
closeProfileModal.addEventListener('click', ()=> profileModal.classList.remove('active'));
profileModal.addEventListener('click', e=>{ if(e.target===profileModal) profileModal.classList.remove('active'); });
addProfileBtn.addEventListener('click', addProfile);
addProfileValue.addEventListener('keydown', e=>{ if(e.key==='Enter'){e.preventDefault();addProfile();} });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoResize() { userInput.style.height='auto'; userInput.style.height=Math.min(userInput.scrollHeight,200)+'px'; }
function updateSendBtn() { sendBtn.disabled=!userInput.value.trim()||isGenerating; }

userInput.addEventListener('input', ()=>{ autoResize(); updateSendBtn(); });
userInput.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} });
sendBtn.addEventListener('click', sendMessage);
newChatBtn.addEventListener('click', createNewChat);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
    // Escape â€” close modal
    if(e.key==='Escape' && profileModal.classList.contains('active')) { profileModal.classList.remove('active'); return; }
    // Ctrl+Shift+O â€” new chat
    if(e.ctrlKey && e.shiftKey && e.key==='O') { e.preventDefault(); createNewChat(); return; }
    // Ctrl+Shift+S â€” toggle sidebar
    if(e.ctrlKey && e.shiftKey && e.key==='S') { e.preventDefault(); toggleSidebar(); return; }
    // Escape during generation â€” stop
    if(e.key==='Escape' && isGenerating && abortController) { abortController.abort(); return; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
    showWelcome();
    await loadConversations();
    loadProfileCount();
    if(conversations.length>0) await selectConversation(conversations[0].id);
}
init();
</script>
</body>
</html>
